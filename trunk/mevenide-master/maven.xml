<project xmlns:maven="jelly:maven" 
		 xmlns:j="jelly:core"
		 xmlns:util="jelly:util"
		 xmlns:ant="jelly:ant"
		 default="mevenide:help">
 

  
  
  <!-- ==================================== -->
  <!--             build section            -->
  <!-- ==================================== -->
  <goal name="mevenide-eclipse:build" description="Build all Mevenide modules" prereqs="mevenide-eclipse:clean,mevenide-eclipse:init">
    <j:set var="maven.multiproject.includes" value="${maven.multiproject.eclipse.includes}"/>
    <j:set var="maven.multiproject.excludes" value="mevenide-master/project.xml"/>
    <attainGoal name="multiproject:goal"/>
    <attainGoal name="mevenide-eclipse:create-update-dist"/>
  </goal>
  
  <goal name="mevenide-netbeans:build" description="Build all Mevenide modules" prereqs="mevenide-netbeans:init, mevenide-netbeans:build-deps">
      <j:set var="maven.multiproject.includes" value="${maven.multiproject.netbeans.includes}"/>
      <j:set var="maven.nbm.cluster.name" value="mevenide"/>
      <j:set var="goal" value="nbm:install"/> 
      <attainGoal name="multiproject:goal"/>
  </goal>
  
  <goal name="mevenide-jbuilder:build" description="Build all Mevenide modules" prereqs="mevenide-jbuilder:clean,mevenide-jbuilder:init">
      <j:set var="maven.multiproject.includes" value="${maven.multiproject.jbuilder.includes}"/>
      <j:set var="maven.multiproject.excludes" value="mevenide-master/project.xml"/>
      <attainGoal name="multiproject:goal"/>
      <attainGoal name="mevenide-jbuilder:create-doc-bundle"/>
  </goal>

  <goal name="mevenide-netbeans:autoupdate">
      <j:set var="maven.nbm.build.release.dir" value="${basedir}/../mevenide-master/target/nbm_release"/>
      <j:set var="maven.nbm.build.dir" value="${basedir}/.."/>
      <attainGoal name="nbm:collect-nbms"/>
      <!-- j:set var="maven.nbm.autoupdate.distbase" value="nb_autoupdate"/ -->
      <attainGoal name="nbm:autoupdate"/>

  </goal>  

    
  <!-- ==================================== -->
  <!--            site generation           -->   
  <!-- ==================================== -->
  <goal name="mevenide-site:build" description="Build Mevenide Site" prereqs="mevenide-site:init">
  	<j:set var="maven.multiproject.includes" value="${maven.multiproject.site.includes}"/>
  	<attainGoal name="multiproject:site"/>
  	<!-- <attainGoal name="mevenide-site:generate-wiki-templates"/> -->
  </goal>
  
  <!-- do NOT call site:deploy because we dont want to attain 'site' goal -->
  <goal name="mevenide-site:ssh-deploy" description="Deploy Site" prereqs="mevenide-site:build">
    <attainGoal name="site:sshdeploy"/>
	<!-- Expand on the server and chmod -->
	<ant:telnet server="${pom.siteAddress}" userid="${maven.username}" password="${maven.password}">
		<ant:read string="%"/>
		<ant:write string="cd ${maven.homepage}; ln -s ../dist/repository repository"/>
		<ant:read string="%"/>
	</ant:telnet>    
    <!-- attainGoal name="spinner-wiki:sshdeploy"/ -->
  </goal>
  
  <goal name="mevenide-site:generate-wiki-templates" description="Build Mevenide Site">
  	<attainGoal name="spinner-wiki:generate-templates"/>
  </goal>
  
  
  <!-- ==================================== -->
  <!--  ide modules initialization section  -->
  <!-- ==================================== -->
  <goal name="mevenide-eclipse:clean" prereqs="clean:clean">
    <ant:delete dir="${maven.repo.local}/eclipse" quiet="true"/>
  	<ant:delete dir="${maven.repo.local}/mevenide" quiet="true"/>
  </goal>
  
  <goal name="mevenide:clean-lib">
     <ant:delete>
        <ant:fileset dir="${basedir}" includes="lib/*.jar"/>
     </ant:delete> 
  </goal>
  
  <goal name="mevenide-eclipse:init" description="Copy eclipse dependencies to maven.repo.local if necessary">
    <util:file var="installScript" name="${basedir}/../${mevenide.master.project.name}/scripts/init/install-eclipse-dependencies.xml"/>
    <j:include file="${installScript}"/>
  </goal>  
  
  <goal name="mevenide-jbuilder:clean" prereqs="mevenide:clean-lib,clean:clean">
    <ant:delete dir="${maven.repo.local}/jbuilder" quiet="true"/>
  	<ant:delete dir="${maven.repo.local}/mevenide" quiet="true"/>
  </goal>
  
  <goal name="mevenide-jbuilder:init" description="Copy JBuilder dependencies to maven.repo.local if necessary">
    <util:file var="installScript" name="${basedir}/../${mevenide.master.project.name}/scripts/init/install-jbuilder-dependencies.xml"/>
    <j:include file="${installScript}"/>
  </goal>  
  
  <goal name="mevenide-netbeans:init" description="Copy netbeans dependencies to maven.repo.local if necessary">
	<!-- j:set var="maven.repo.remote" value="${maven.repo.remote},http://mevenide.codehaus.org/repository"/>
    <j:set var="artifactId" value="maven-nbm-plugin"/>
    <j:set var="groupId" value="mevenide"/>
    <j:set var="version" value="0.2"/>
    <attainGoal name="plugin:download"/ -->
    
	<!-- util:file var="installScript" name="${basedir}/../${mevenide.master.project.name}/scripts/init/install-netbeans-dependencies.xml"/>
    <j:include file="${installScript}"/ -->
  </goal>  

  <goal name="mevenide-ide:init-all" description="Try to install eclipse and netbeans dependencies. Used to initialize repository before building site.">
      <ant:property environment="env"/>
      <ant:property name="eclipse_home" location="env.ECLIPSE_HOME"/>
	  <!-- ant:property name="netbeans_home" location="env.NETBEANS_HOME"/ -->
      <j:if test="${!empty(eclipse_home)}">
        <attainGoal name="mevenide-eclipse:init"/>
      </j:if>
	 <!-- j:if test="${!empty(netbeans_home)}">
        <attainGoal name="mevenide-netbeans:init"/>  
      </j:if -->
  </goal>
  
  
  <!-- ==================================== -->
  <!--      site initialization section     -->
  <!-- ==================================== -->
  <goal name="mevenide-site:set-clover-jar" description="Set clover overriden jar">
      <j:set var="maven.jar.override" value="on"/>
      <j:set var="maven.clover.jar" value="${mevenide.master.project.location}/lib/clover/jars/clover-1.2.4.jar"/>
  </goal>
  
  <goal name="mevenide-site:install-css" description="Iterate each subprojects and copy master project.css to ${subproject.location}/xdocs/style">
      <util:tokenize var="projects" delim=",">${maven.multiproject.site.includes}</util:tokenize>
      <j:forEach var="project" items="${projects}">
          <util:file var="projectFile" name="${project}"/>
          <ant:copy file="${mevenide.master.project.location}/xdocs/style/project.css" 
                    todir="${basedir}/../${projectFile.getParent()}/xdocs/style" overwrite="true"/>
      </j:forEach>
  </goal>
  
  <goal name="mevenide-site:quick-init" 
        description="Similar to main initialization goal but doesnot clean anything" 
        prereqs="mevenide-site:set-clover-jar,mevenide-site:install-css" />
  
  <goal name="mevenide-site:init" 
        description="Main initialization goal" 
        prereqs="mevenide-ide:init-all,mevenide-site:quick-init" />
  
  
  <!-- ==================================== -->
  <!--   eclipse plugins creation section   -->
  <!-- ==================================== -->
  <goal name="mevenide-eclipse:create-update-dist" prereqs="mevenide-eclipse:init" description="Build Eclipse plugin update site">
   	<util:file var="updateSiteProjectDescriptor" name="${mevenide.eclipse.update.project.location}/project.xml"/>
    <maven:maven descriptor="${updateSiteProjectDescriptor}" goals="eclipse-plugin:create-artifact-dist"/>
  </goal>
  
  <preGoal name="eclipse-plugin:install-artifact">
  	<util:file var="filters" name="${mevenide.master.project.location}/scripts/init/init-filtersets.xml"/>
  	<j:include file="${filters}"/>
  </preGoal>

  <!-- ==================================== -->
  <!--      netbeans section                -->
  <!-- ==================================== -->
  <goal name="mevenide-netbeans:clean" description="clean all Mevenide modules" prereqs="">
      <j:set var="maven.multiproject.includes" value="${maven.multiproject.netbeans.includes}"/>
      <j:set var="goal" value="clean"/> 
      <attainGoal name="multiproject:goal"/>
      <ant:delete dir="${maven.repo.local}/mevenide" quiet="true"/>
  </goal>

  <goal name="mevenide-netbeans:build-deps" description="Create nbms for the Mevenide dependencies" prereqs="mevenide-netbeans:init">
	<!-- j:scope> -->
        <j:set var="backupincludes" value="${maven.multiproject.includes}"/>
        <j:set var="maven.nbm.cluster.name" value="mevenide"/>
		<!-- j:set var="backupbasedir" value="${maven.multiproject.basedir}"/ -->
		<!--  j:set var="maven.multiproject.basedir" value="${basedir}/../mevenide-netbeans-deps"/ -->
        <j:set var="maven.multiproject.includes" value="mevenide-netbeans-deps/*/project.xml"/>
        <j:set var="goal" value="nbm:install"/> 
        <attainGoal name="multiproject:goal"/>
        <!-- how to execute without influencing the original -->
        <j:set var="maven.multiproject.includes" value="${backupincludes}"/>
		<!--  j:set var="maven.multiproject.basedir" value="${backupbasedir}"/ -->
	<!-- /j:scope -->
  </goal>  
    
  <!-- ==================================== -->
  <!--           jbuilder section           -->
  <!-- ==================================== -->    
  <goal name="mevenide-jbuilder:create-doc-bundle">
  	<j:set var="maven.multiproject.includes" value="${mevenide.ui.jbuilder.project.name}/project.xml"/>
  	<j:set var="goal" value="xdoc"/>
  	<attainGoal name="multiproject:goal"/>
  	<ant:jar destfile="${mevenide.ui.jbuilder.project.location}/mevenide-ui-jbuilder-doc.jar">
  		<fileset dir="${mevenide.ui.jbuilder.project.location}/target/docs">
  	  	  <include name="JBMavenOpenTool.html"/>
		</fileset>
  	</ant:jar> 
  </goal>

  <!-- ==================================== -->
  <!--           optional section           -->
  <!-- ==================================== -->
  <goal name="mevenide:install-maven-eclipse-plugin-plugin" description="Checkout maven-eclipse-plugin-plugin from cvs and install it">
  	 <attainGoal name="scm:checkout-project"/>
  	 <util:file var="mavenEclipsePluginPluginPom" name="${maven.scm.checkout.dir}/maven-plugins/maven-eclipse-plugin-plugin/project.xml"/>
	 <maven:maven descriptor="${mavenEclipsePluginPluginPom}" goals=" plugin:install,plugin:deploy"/>
  </goal>  

  <goal name="mevenide:install-maven-nbm-plugin" description="Checkout maven-nbm-plugin from cvs and install it">
    <j:set var="maven.scm.cvs.module" value="maven-plugins/maven-nbm-plugin"/>
  	 <attainGoal name="scm:checkout-project"/>
  	 <util:file var="mavenNbmPluginPom" name="${maven.scm.checkout.dir}/maven-plugins/maven-nbm-plugin/project.xml"/>
	 <maven:maven descriptor="${mavenNbmPluginPom}" goals=" plugin:install,plugin:deploy"/>
  </goal>  
  
  
  <!-- ==================================== -->
  <!--     individual sites generation      -->
  <!-- ==================================== -->
  <goal name="mevenide-site:common" prereqs="mevenide-site:quick-init">
  	<j:set var="maven.multiproject.includes" value="${maven.multiproject.common.includes}"/>
  	<attainGoal name="multiproject:site"/>
  </goal>
  
  <goal name="mevenide-site:eclipse" prereqs="mevenide-site:quick-init">
  	<j:set var="maven.multiproject.includes" value="${mevenide.ui.eclipse.project.name}/project.xml"/>
  	<attainGoal name="multiproject:site"/>
  </goal>
  
  <goal name="mevenide-site:plugins" prereqs="mevenide-site:quick-init">
  	<j:set var="maven.multiproject.includes" value="${mevenide.eclipse.plugin.project.name}/project.xml,${mevenide.nbm.plugin.project.name}/project.xml,${mevenide.spinner.wiki.plugin.project.name}/project.xml"/>
  	<attainGoal name="multiproject:site"/>
  </goal>
  
  <goal name="mevenide-site:netbeans" prereqs="mevenide-site:quick-init">
  	<j:set var="maven.multiproject.includes" value="${mevenide.ui.netbeans.project.name}/project.xml,${mevenide.netbeans.grammar.project.name}/project.xml"/>
  	<attainGoal name="multiproject:site"/>
  </goal>
  
  <goal name="mevenide-site:jbuilder" prereqs="mevenide-site:quick-init">
  	<j:set var="maven.multiproject.includes" value="${mevenide.ui.jbuilder.project.name}/project.xml"/>
  	<attainGoal name="multiproject:site"/>
  </goal>
  
  
  <!-- ==================================== -->
  <!--              help section            -->
  <!-- ==================================== -->  
  <goal name="mevenide:help">
  	<ant:echo>

Below are listed relevant goals in the context of the Mevenide project.
  		
[Building IDE plugins]
----------------------

  o mevenide-eclipse:build
	 Builds Eclipse plugin. It assumes that you have ECLIPSE_HOME environment variable set.
	 Also it requires that maven-eclipse-eclipse-plugin is installed. You can grab it here : 
	 http://dist.codehaus.org/mevenide/dist/repository/mevenide/plugins/
	 Generated artifacts are dropped to mevenide-update/target/eclipse/dist
         Make sure the IDE is installed before running maven because 
         the build process will grab libraries from the install directory.
	 
  o mevenide-netbeans:build
	 Builds Netbeans modules (NBMs). 
	 Also it requires that maven-nbm-plugin is installed. You can grab it here : 
	 http://mevenide.codehaus.org/repository/mevenide/plugins/
         Or by running "maven -DartifactId=maven-nbm-plugin -DgroupId=mevenide -Dversion=[CURRENT_VERSION] plugin:download"
         All required dependencies should be retrieved from the remote repository.
         For a complete build, run maven "mevenide-netbeans:build mevenide-netbeans:autoupdate"
         All built NBMs will be then placed under mevenide-master/target/nbm_release directory. 
	 
  
[Building Mevenide site]
------------------------
  
  o mevenide-site:build
     Builds whole Mevenide site.
      
  o mevenide-site:eclipse
     Builds Mevenide Eclipse site part
     
[Building utility maven plugins]
--------------------------------

  o mevenide:install-maven-eclipse-plugin-plugin
     Builds and deploys the maven-eclipse-eclipse-plugin used to build Eclipse plugin
     
  o mevenide:install-maven-nbm-plugin   
     (Deprecated) Builds and deploys the maven-nbm-plugin used to build Netbeans plugin
     Download the plugin by running
       "maven -DartifactId=maven-nbm-plugin -DgroupId=mevenide -Dversion=[CURRENT_VERSION] plugin:download"
     
  	</ant:echo>
  </goal>
  
</project>
