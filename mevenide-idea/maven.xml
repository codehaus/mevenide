<?xml version="1.0" encoding="UTF-8"?>

<project xmlns:maven="jelly:maven" xmlns:ant="jelly:ant" xmlns:j="jelly:core" xmlns:u="jelly:util">

    <ant:path id="idea.classpath">
        <ant:pathelement location="${idea.home}\lib\idea.jar"/>
        <ant:pathelement location="${idea.home}\lib\extensions.jar"/>
        <ant:pathelement location="${idea.home}\lib\openapi.jar"/>
        <ant:pathelement location="${idea.home}\lib\log4j.jar"/>
        <ant:pathelement location="${idea.home}\lib\idea_rt.jar"/>
    </ant:path>

    <goal name="idea:run" prereqs="idea:deploy">

        <ant:echo></ant:echo>
        <ant:echo></ant:echo>
        <ant:echo>=============================================</ant:echo>
        <ant:echo>Running IntelliJ IDEA:</ant:echo>
        <ant:echo>=============================================</ant:echo>
        <ant:echo></ant:echo>
        <ant:echo></ant:echo>

        <ant:java classname="com.intellij.rt.execution.application.AppMain"
                  classpathref="idea.classpath"
                  fork="true"
                  spawn="false"
                  jvm="${idea.home}\jre\bin\java"
                  failonerror="true"
                  dir="${idea.home}\bin">

            <ant:jvmarg value="-Xbootclasspath/p:${idea.home}\lib\boot.jar"/>

            <ant:sysproperty key="idea.config.path" value="${idea.sandbox}\config"/>
            <ant:sysproperty key="idea.system.path" value="${idea.sandbox}\system"/>
            <ant:sysproperty key="idea.plugins.path" value="${idea.sandbox}\plugins"/>
            <ant:sysproperty key="idea.launcher.port" value="7532"/>
            <ant:sysproperty key="idea.launcher.bin.path" value="${idea.home}\bin"/>
            <ant:sysproperty key="file.encoding" value="UTF-8"/>

            <ant:arg value="com.intellij.idea.Main"/>

        </ant:java>
    </goal>

    <goal name="idea:debug" prereqs="idea:deploy">

        <ant:echo></ant:echo>
        <ant:echo></ant:echo>
        <ant:echo>=============================================</ant:echo>
        <ant:echo>Debugging IntelliJ IDEA:</ant:echo>
        <ant:echo>=============================================</ant:echo>
        <ant:echo></ant:echo>
        <ant:echo></ant:echo>

        <ant:java classname="com.intellij.idea.Main"
                  classpathref="idea.classpath"
                  fork="true"
                  spawn="false"
                  jvm="${idea.home}\jre\bin\java"
                  failonerror="true"
                  dir="${idea.home}\bin">

            <ant:jvmarg value="-Xbootclasspath/p:${idea.home}\lib\boot.jar"/>
            <ant:jvmarg value="-Xdebug"/>
            <ant:jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=4795"/>
            <ant:jvmarg value="-Xnoagent"/>

            <ant:sysproperty key="java.compiler" value="NONE"/>
            <ant:sysproperty key="idea.config.path" value="${idea.sandbox}\config"/>
            <ant:sysproperty key="idea.system.path" value="${idea.sandbox}\system"/>
            <ant:sysproperty key="idea.plugins.path" value="${idea.sandbox}\plugins"/>
            <ant:sysproperty key="file.encoding" value="UTF-8"/>

        </ant:java>
    </goal>

    <goal name="idea:clean">

        <!-- clean sandbox -->
        <ant:delete dir="${idea.sandbox.dir}"/>

    </goal>

    <goal name="idea:copy-license">
        <ant:mkdir dir="${idea.sandbox}\config"/>
        <ant:copy file="${idea.license.file}" todir="${idea.sandbox}\config"/>
    </goal>

    <goal name="idea:deploy" prereqs="idea:copy-license,multiproject:install">

        <!-- deploy modules to sandbox -->
        <maven:reactor
            basedir="${maven.multiproject.basedir}"
            includes="${maven.multiproject.includes}"
            excludes="${maven.multiproject.excludes}"
            collectOnly="true"
            goals="jar"
            collectionVar="modules"
            ignoreFailures="false"/>

        <j:forEach var="module" items="${modules}">

            <!-- copy project dependencies to sandbox -->
            <j:forEach var="artifact" items="${module.artifacts}">
                <j:set var="dep" value="${artifact.dependency}"/>
                <j:if test="${dep.getProperty('idea.plugin.bundle')=='true'}">

                    <!-- find the dependency file -->
                    <u:file var="f" name="${artifact.file.parent}/${artifact.file.name}"/>

                    <!-- find where we should put the dependency in the sandbox -->
                    <j:set var="targetPath" value="${dep.getProperty('idea.plugin.target.path')}"/>
                    <j:set var="fullTargetPath" value="${idea.sandbox.dir}/${targetPath}"/>

                    <!-- make sure target path exists for dependency and copy the file -->
                    <ant:mkdir dir="${fullTargetPath}"/>
                    <ant:copy file="${f}" todir="${fullTargetPath}"/>

                </j:if>
            </j:forEach>

            <!-- copy project artifact to sandbox -->
            <j:set var="module.build.dir"
                   value="${module.getContext().getVariable('maven.build.dir')}"/>
            <j:set var="module.final.name"
                   value="${module.getContext().getVariable('maven.final.name')}"/>
            <j:set var="module.target.path"
                   value="${module.getContext().getVariable('idea.plugin.target.path')}"/>
            <j:set var="module.fulltarget.path" value="${idea.sandbox.dir}/${module.target.path}"/>
            <ant:mkdir dir="${module.fulltarget.path}"/>
            <ant:copy file="${module.build.dir}/${module.final.name}.jar"
                      todir="${module.fulltarget.path}"/>

        </j:forEach>
    </goal>

    <postGoal name="dist:prepare-bin-filesystem">

        <ant:echo>

            +-------------------------------------------------------------------------+
            | Adding required Maven and modules dependencies to binary distribution. |
            +-------------------------------------------------------------------------+

        </ant:echo>

        <!-- this is the directory containing the plugin, and should be copied into the IDEA -->
        <j:set var="plugin.root" value="${maven.dist.bin.assembly.dir}/plugins/mevenide-idea"/>
        <ant:echo message="Plugin root dir is: ${plugin.root}"/>

        <!-- build and install modules -->
        <maven:reactor
            basedir="${maven.multiproject.basedir}"
            includes="${maven.multiproject.includes}"
            excludes="${maven.multiproject.excludes}"
            goals="jar:install"
            ignoreFailures="false"/>

        <!-- deploy modules to sandbox -->
        <maven:reactor
            basedir="${maven.multiproject.basedir}"
            includes="${maven.multiproject.includes}"
            excludes="${maven.multiproject.excludes}"
            collectOnly="true"
            collectionVar="modules"
            ignoreFailures="false"/>

        <j:forEach var="module" items="${modules}">

            <ant:echo message="Copying module ${module.name} dependencies to distribution"/>

            <!-- copy project dependencies to sandbox -->
            <j:forEach var="artifact" items="${module.artifacts}">
                <j:set var="dep" value="${artifact.dependency}"/>

                <j:if test="${!dep.getProperty('idea.plugin.bundle')=='true'}">
                    <ant:echo message="Dependency ${dep.groupId}.${dep.artifactId} will not be copied."/>
                </j:if>

                <j:if test="${dep.getProperty('idea.plugin.bundle')=='true'}">

                    <!-- find the dependency file -->
                    <u:file var="f" name="${artifact.file.parent}/${artifact.file.name}"/>

                    <!-- find where we should put the dependency in the sandbox -->
                    <j:set var="targetPath" value="${dep.getProperty('idea.plugin.target.path')}"/>
                    <j:set var="fullTargetPath" value="${plugin.root}/${targetPath}"/>
                    <ant:echo message="Dependency ${dep.groupId}.${dep.artifactId} will be copied to ${fullTargetPath}."/>

                    <!-- make sure target path exists for dependency and copy the file -->
                    <ant:mkdir dir="${fullTargetPath}"/>
                    <ant:copy file="${f}" todir="${fullTargetPath}"/>

                </j:if>
            </j:forEach>

            <!-- copy project artifact to sandbox -->
            <j:set var="module.build.dir"
                   value="${module.getContext().getVariable('maven.build.dir')}"/>
            <j:set var="module.final.name"
                   value="${module.getContext().getVariable('maven.final.name')}"/>
            <j:set var="module.target.path"
                   value="${module.getContext().getVariable('idea.plugin.target.path')}"/>
            <j:set var="module.fulltarget.path" value="${plugin.root}/${module.target.path}"/>
            <ant:echo message="Module ${module.groupId}.${module.artifactId} will be copied to ${module.fulltarget.path}."/>
            <ant:mkdir dir="${module.fulltarget.path}"/>
            <ant:copy file="${module.build.dir}/${module.final.name}.jar"
                      todir="${module.fulltarget.path}"/>

        </j:forEach>

        <!-- delete the JAR file, which contains nothing anyway -->
        <delete>
            <ant:fileset dir="${maven.dist.bin.assembly.dir}" includes="${maven.final.name}.jar"/>
        </delete>

    </postGoal>

    <!-- override site:generate so that the dist plugin takes the aggregated site -->
    <goal name="site:generate">
        <attainGoal name="multiproject:site"/>
    </goal>

    <goal name="idea:create-plugin-descriptor-jar">
        <ant:jar destfile="${idea.sandbox}/plugins/mevenide-idea/lib/plugin.jar">
            <ant:zipfileset dir="../mevenide-idea-main/src/main/etc" includes="*.xml" prefix="META-INF/"/>
        </ant:jar>
    </goal>
</project>